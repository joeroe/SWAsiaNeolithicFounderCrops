---
title: 'Revisiting the concept of the "Neolithic Founder Crops" in southwest Asia'
subtitle: "Quantitative analysis"
author:
  - first_name: "Joe"
    last_name: "Roe"
    url: https://joeroe.io
    orcid_id: 0000-0002-1011-1244
  - first_name: "Amaia"
    last_name: "Arranz-Otaegui"
    orcid_id: 0000-0002-5091-6426
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 4
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE
)
```

```{r deps}
library("tidyverse")
library("SWAsiaNeolithicFounderCrops")
library("swapdata")
library("sf")
library("ggspatial")
library("ggstream")
library("here")
library("gt")
library("glue")
library("patchwork")
library("khroma")
```

This document describes the quantitative analysis our paper *Revisiting the concept of the “Neolithic Founder Crops” in southwest Asia* (Arranz-Otaegui & Roe 2022).
It is generated from the compendium of R code and data available at <https://github.com/joeroe/SWAsiaNeolithicFounderCrops>).

## Methods & Materials

The nature of our data and quantitative methods are described in general terms in the body of the paper.
Here, we explain in more detail the methods used to transform our raw data and produce the figures, tables, and results presented.
For the precise steps needed to reproduce this analysis, see the underlying R code and data files available in the compendium.

### Study region and period

```{r data-spatial, fig.cap='The study region', results='hide', layout='l-body-outset'}
proj <- 22770
unproj <- 4326

sw_asia <- st_read(here("analysis/data/raw_data/regions/swasia.geojson"))

land <- st_read(here("analysis/data/raw_data/ne/ne_50m_land.shp"))
rivers <- st_read(here("analysis/data/raw_data/ne/ne_50m_rivers_lake_centerlines_scale_rank.shp"))
lakes <- st_read(here("analysis/data/raw_data/ne/ne_50m_lakes.shp"))
highland <- st_read(here("analysis/data/raw_data/srtm/srtm30_sw_asia_1000m.geojson"))
highland <- filter(highland, above_1000m == 1)

base_map <- ggplot() +
  shadow_spatial(st_bbox(sw_asia), fill = NA) +
  annotation_spatial(land, fill = "white") +
  annotation_spatial(highland, fill = "#f0f0f0", colour = NA) +
  annotation_spatial(rivers, colour = "#555555", size = 0.5) +
  annotation_spatial(lakes, fill = "lightblue") +
  coord_sf(expand = FALSE, crs = proj)

base_map
```

We aimed to collate archaeobotanical data from Southwest Asia (fig. \@ref(fig:data-spatial)) from the Neolithic period, c. 11,700 – 6500 BP (table \@ref(tab:periods)).
To mitigate against an "edge effect", we also included samples in the source databases dated to the preceding Late Epipalaeolithic (c. 15,000–11,700 BP) and succeeding Chalcolithic (c. 6500–5000 BP).

```{r periods}
periods <- tribble(
  ~period,             ~agriculture,                          ~start_bp, ~end_bp,
  "Late Epipal.",      "Foraging",                            15000,     11700,
  "PPNA",              "Pre-domestication cultivation",       11700,     10700,
  "EPPNB",             "Cultivation of domesticated species", 10700,     10200,
  "MPPNB",             "Cultivation of domesticated species", 10200,     9500,
  "LPPNB/C",           "Agriculture",                         9500,      8500,
  "Pottery Neolithic", "Agriculture",                         8500,      6500,
  "Chalcolithic",      "Agriculture",                         6500,      5000,
)

neolithic <- c("PPNA", "EPPNB", "MPPNB", "LPPNB/C", "Pottery Neolithic")
neolithic_start <- max(filter(periods, period %in% neolithic) %>% select(start_bp))
neolithic_end <- min(filter(periods, period %in% neolithic) %>% select(end_bp))

periods %>% 
  gt(caption = "Cultural periods used in the analysis") %>% 
  cols_label(period = "Period", agriculture = "Subsistence",
             start_bp = "Start (cal BP)", end_bp = "End (cal BP")
```

### Archaeobotanical data

We collated data from three large-scale archaeobotanical databases: ORIGINS [@Wallace2018], and COMPAG [@Lucas2018, @Fuller2018; incorporating @Shennan2007, @Colledge2004], and ADEMNES [@Riehl2005].
To clean and make these datasets comparable, we:

* Standardised site names across databases (thesaurus available at <https://github.com/joeroe/swapdata>);
* Standardised taxonomic names across databases and applied various additional classifications described below;
* When sites were in multiple databases, preferred records from the most detailed/recent one (i.e. ORIGINS > COMPAG > ADEMNES);
* ORIGINS is recorded by sample, but COMPAG and ADEMNES by phase, so aggregated ORIGINS by phase for comparability – and because individual samples are more likely to be 'noisy';
* Calculated phase-level proportions for COMPAG, which only includes absolute frequencies;
* Excluded records from the source databases that:
  * Were not taxonomically determined to at least the level of genus;
  * Did not actually contain quantitative information (i.e. `n` is blank or missing);
  * Described wood remains.

Finally we filtered this data to include only samples from our region (Southwest Asia) and period (11.7–6.5 ka cal BP) of interest,
with a buffer of ±2,000 years to reduce "edge effects" in our time series analyses.

```{r data-flora}
start_bp <- first(periods$start_bp)
end_bp <- last(periods$end_bp)
flora <- collate_flora(
  origins_path = here("analysis/data/raw_data/origins/"),
  ademnes_path = here("analysis/data/raw_data/ademnes"),
  compag_path = here("analysis/data/raw_data/compag2018"),
  taxa_path = here("analysis/data/raw_data/founder_crops.tsv"),
  region = sw_asia,
  start_bp = start_bp,
  end_bp = end_bp
)

# TODO: Warnings in collate_flora()

# Final cleaning
# Drop records that are insufficiently taxonomically determined (taxon = NA) or
# which don't actually have quantitative information, to make sure they don't
# throw off our ubiquity measures. 
# We don't update prop, so they are still accounted for in abundance measures.
flora %>% 
  drop_na(taxon) %>% 
  drop_na(prop) %>% 
  filter(prop != 0)  %>% 
  filter(!wood | is.na(wood)) %>% 
  select(-wood) ->
  flora

# Summary totals
flora %>% 
  distinct(site_name) %>% 
  nrow() ->
  n_site

flora %>% 
  distinct(site_name, phase_code) %>% 
  nrow() ->
  n_assemb
```

The resulting collated dataset (`analysis/data/derived_data/swasia_neolithic_flora.tsv`) includes archaeobotanical assemblages representing `r n_assemb` distinct phases from `r n_site` sites.

### Chronological data

All three databases include rough absolute date ranges (in the vast majority of cases summarised the available radiocarbon dates) for each sample.
Using this data, each phase was classified into one of the cultural periods defined above using its mid-point date (table \@ref(tab:sample-periods)).

```{r sample-periods}
flora <- mutate(
  flora,
  age_mid = age_end + ((age_start - age_end) / 2),
  period = cut(-age_mid, 
               breaks = -c(periods$start_bp, 0), 
               labels = periods$period,
               ordered_result = TRUE)
)

flora %>% 
  distinct(period, site_name, phase) %>% 
  add_count(period, name ="n_phases") %>% 
  distinct(period, site_name, n_phases) %>% 
  add_count(period, name = "n_sites") %>% 
  distinct(period, n_phases, n_sites) %>% 
  select(period, n_sites, n_phases) %>% 
  arrange(period) %>%
  gt(caption = "Sites and assemblages per period") %>% 
  cols_label(period = "Period", n_sites = "Sites", n_phases = "Assemblages") 

flora %>% 
  distinct(site_name, phase_code, period) %>% 
  filter(period %in% neolithic) %>% 
  nrow() ->
  n_assemb_neolithic

flora %>% 
  filter(period %in% neolithic) %>% 
  distinct(site_name) %>% 
  nrow() ->
  n_site_neolithic
```

For a finer-grained chronology, we also sliced the assemblages into century bins.
An assemblage was considered to belong to a bin (e.g. 5000–5099 BP) if any part of its absolute date range falls within that bin – this results in the duplication of data across bins, but better reflects the inherent imprecision of radiocarbon dating.

```{r sample-centuries}
centuries <- seq(from = first(periods$start_bp),
                 to = last(periods$end_bp),
                 by = -100)
names(centuries) <- centuries

flora %>% 
  mutate(century = map_dfc(centuries, ~. < age_start & . > age_end)) %>% 
  unpack(century) %>% 
  pivot_longer((ncol(flora)+1):ncol(.), names_to = "century",
               names_transform = list(century = as.integer)) %>% 
  filter(value) %>% 
  select(-value) %>% 
  mutate(period = cut(-century, 
               breaks = -c(periods$start_bp, last(periods$end_bp)), 
               labels = periods$period,
               ordered_result = TRUE)) ->
  flora_ts
```

### Sample coverage

We are now in a position to inspect the geographical (fig. \@ref(fig:sample-map)) and temporal \@ref(fig:sample-chronology) coverage of the data.
Unsurprisingly, the distribution is uneven. 
Notably, we have few Epipalaeolithic sites, but a very large number of Chalcolithic sites;
the regional coverage reflects broader trends in the research history of the region, with a large body of evidence from the Southern Levant, especially for earlier periods, and the rest of the region more patchily covered.
Nevertheless, we have a decent baseline number of samples for each time slice in our analysis—the lowest is 11 assemblages, for the EPPNB—especially for the key Neolithic periods.

```{r sample-summary}
flora %>% 
  group_by(site_name, phase_code) %>% 
  summarise(across(c(source, latitude, longitude, phase, age_start, age_end,
                     period), first),
            .groups = "drop") ->
  flora_phases
```


```{r sample-map, fig.cap='Geographical distribution of sampled archaeobotanical assemblages', layout='l-body-outset'}
p1 <- base_map + 
  geom_spatial_point(data = flora_phases, 
                     mapping = aes(longitude, latitude),
                     size = 0.5) +
  labs(x = NULL, y = NULL)
  
p1_left <- p1 + facet_wrap(vars("All sites"))
p1_right <- p1 + 
  facet_wrap(vars(period)) + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

p1_left + p1_right

# ggsave(here("analysis/figures/sample-map.pdf"), width = 235, height = 160, 
#        units = "mm")
# ggsave(here("analysis/figures/sample-map.png"), width = 160, height = 80,
#        units = "mm", dpi = 300)
```


```{r sample-chronology, fig.cap='Distribution of sampled archaeobotanical assemblages by cultural period. Black lines indicate our period of interest (the Neolithic).', layout='l-body-outset'}
p2_top <- flora_phases %>% 
  count(period) %>% 
  left_join(periods) %>% 
  mutate(period = ordered(period, levels = periods$period)) %>% 
  ggplot(aes(xmin = start_bp, xmax = end_bp, ymin = 0, ymax = n,
             fill = period)) +
  geom_rect() +
  geom_vline(xintercept = c(neolithic_start, neolithic_end)) +
  scale_x_reverse(limits = c(15000, 5000),
                  breaks = seq(15000, 5000, -1000)) +
  scale_y_continuous(limits = c(0, 150)) +
  khroma::scale_fill_muted() +
  labs(x = NULL, y = "Samples by period", fill = "Period") +
  theme_minimal() +
  theme(legend.position = "right", 
        axis.text.x = element_blank(), axis.ticks.x = element_blank())

p2_bottom <- flora_ts %>% 
  group_by(site_name, phase_code, century) %>% 
  summarise(period = first(period), .groups = "drop") %>% 
  ggplot(aes(century, fill = period)) +
  geom_bar(width = 100) +
  geom_vline(xintercept = c(neolithic_start, neolithic_end)) +
  scale_x_reverse(limits = c(15000, 5000), 
                  breaks = seq(15000, 5000, -1000)) +
  scale_y_reverse(limits = c(150, 0)) +
  khroma::scale_fill_muted(guide = guide_none()) +
  labs(x = "cal BP", y = "Samples by century") +
  theme_minimal() +
  theme(legend.position = "bottom")

p2_top / p2_bottom

# ggsave(here("analysis/figures/sample-chronology.pdf"), width = 160, height = 100, 
#        units = "mm")
```

## Results

### Taxonomic ubiquity in the Neolithic

Table \@ref(tab:all-ubiquity) summarises the occurrence of each standardised taxon across Neolithic assemblages, broken down by plant category.

```{r all-ubiquity, layout='l-body-outset'}
flora %>% 
  drop_na(category, taxon) %>% 
  filter(period %in% neolithic) %>% 
  group_by(category, taxon, founder_crop, phase_code) %>% 
  summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop_last") %>% 
  summarise(
    n_present = sum(prop > 0),
    n_gthalf = sum(prop > 0.5),
    n_gtqrtr = sum(prop > 0.25),
    .groups = "drop"
  ) %>% 
  mutate(
    pct_present = n_present / n_assemb_neolithic,
    pct_gthalf = n_gthalf / n_assemb_neolithic,
    pct_gtqrtr = n_gtqrtr / n_assemb_neolithic
  ) %>% 
  group_by(category) %>% 
  arrange(-n_present, .by_group = TRUE) %>% 
  # slice_max(n_present, n = 20, with_ties = FALSE) %>%
  gt(caption = "Ubiquity of all taxa across Neolithic assemblages. Founder crops are highlighted in bold.") %>% 
  cols_hide(c(founder_crop)) %>% 
  fmt_percent(c(pct_present, pct_gthalf, pct_gtqrtr)) %>% 
  cols_merge_n_pct(n_present, pct_present) %>% 
  cols_merge_n_pct(n_gthalf, pct_gthalf) %>% 
  cols_merge_n_pct(n_gtqrtr, pct_gtqrtr) %>% 
  cols_label(taxon = "Taxa",
             n_present = "N (%) recorded present",
             n_gthalf = "N (%) making up more than half of assemblage",
             n_gtqrtr = "N (%) making up more than a quarter of assemblage") %>% 
  tab_style(cell_text(weight = "bold"), cells_body(rows = !is.na(founder_crop)))
```

This summary data underlies figure X in the main text.

```{r all-ubiquity-plot, fig.height=12, include=FALSE}
flora %>% 
  drop_na(category, taxon) %>% 
  filter(period %in% neolithic) %>% 
  group_by(category, taxon, founder_crop, phase_code) %>% 
  summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop_last") %>% 
  summarise(
    n_present = sum(prop > 0),
    n_gthalf = sum(prop > 0.5),
    n_gtqrtr = sum(prop > 0.25),
    .groups = "drop"
  ) %>% 
  mutate(
    pct_present = n_present / n_assemb_neolithic,
    pct_gthalf = n_gthalf / n_assemb_neolithic,
    pct_gtqrtr = n_gtqrtr / n_assemb_neolithic
  ) %>% 
  group_by(category) %>% 
  slice_max(n_present, n = 15, with_ties = FALSE) %>% 
  mutate(taxon = fct_reorder(taxon, n_present, .desc = FALSE)) %>% 
  ggplot(aes(taxon, pct_present, fill = !is.na(founder_crop))) +
  facet_wrap(vars(category), ncol = 1, scales = "free_y") +
  geom_col(colour = "black") +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_trunc(x, 40)) +
  scale_y_continuous(labels = scales::label_percent()) +
  scale_fill_manual(values = c("white", "black"), guide = FALSE) +
  labs(x = NULL, y = "Assemblages present", 
       caption = "Includes only the 15 most ubiquitous taxa in each category.") +
  theme_minimal()

# gtsave(occ_all, "figures/occ_all.html")
```

### Founder crop ubiquity and abundance

#### By period

Table \@ref(tab:founder-ubiquity) summarises the ubiquity of the founder crop species in assemblages broken down by period, i.e. for each period, it shows the number of assemblages where *N* distinct founder species are present, for varying values of *N*.
Given the inconsistent levels of identification between assemblages, emmer wheat and einkorn wheat are counted as one crop.
Hence, the maximum possible number of founder crops present is seven rather than eight.

```{r founder-ubiquity, layout='l-body-outset'}
flora %>% 
  mutate(founder_crop = recode(founder_crop,
                               "emmer wheat" = "wheat",
                               "einkorn wheat" = "wheat",
                               .default = founder_crop)) %>% 
  group_by(period, site_name, phase_code) %>% 
  summarise(n_founder_crop = n_distinct(founder_crop, na.rm = TRUE),
            .groups = "drop") %>% 
  group_by(period) %>% 
  summarise(
    n_assemb = n(),
    n_atleast7 = sum(n_founder_crop >= 7),
    p_atleast7 = n_atleast7 / n_assemb,
    n_atleast6 = sum(n_founder_crop >= 6),
    p_atleast6 = n_atleast6 / n_assemb,
    n_atleast5 = sum(n_founder_crop >= 5),
    p_atleast5 = n_atleast5 / n_assemb,
    n_atleast4 = sum(n_founder_crop >= 4),
    p_atleast4 = n_atleast4 / n_assemb,
    n_atleast3 = sum(n_founder_crop >= 3),
    p_atleast3 = n_atleast3 / n_assemb,
    n_atleast2 = sum(n_founder_crop >= 2),
    p_atleast2 = n_atleast2 / n_assemb,
    n_atleast1 = sum(n_founder_crop >= 1),
    p_atleast1 = n_atleast1 / n_assemb
  ) %>% 
  gt(caption = "Ubiquity of the founder crops by period.") %>% 
  fmt_percent(starts_with("p_")) %>% 
  cols_merge_n_pct(n_atleast7, p_atleast7) %>% 
  cols_merge_n_pct(n_atleast6, p_atleast6) %>% 
  cols_merge_n_pct(n_atleast5, p_atleast5) %>% 
  cols_merge_n_pct(n_atleast4, p_atleast4) %>% 
  cols_merge_n_pct(n_atleast3, p_atleast3) %>% 
  cols_merge_n_pct(n_atleast2, p_atleast2) %>% 
  cols_merge_n_pct(n_atleast1, p_atleast1) %>% 
  tab_spanner("Number of assemblages with N founder crops present:",
              columns = starts_with("n_atleast"), id = "n_atleast") %>% 
  cols_label(
    period = "Period",
    n_assemb = "Total assemblages",
    n_atleast7 = "All",
    n_atleast6 = ">= 6",
    n_atleast5 = ">= 5",
    n_atleast4 = ">= 4",
    n_atleast3 = ">= 3",
    n_atleast2 = ">= 2",
    n_atleast1 = ">= 1"
  )
```

#### By century

For a more fine-grained look at the time series, we can use the century bins calculated above, 
Measured by cross-assemblage ubiquity (number of assemblages dated to each century where the taxon is present) and by relative abundance (average proportion across assemblages dated to each century).

```{r ts-founder-crops, fig.cap='Ubiquity and abundance of the founder crops by century', fig.height=6, layout='l-body-outset'}
# By ubiquity
flora_ts %>% 
  # Count number of assemblages with founder crops per century
  mutate(founder_crop = recode(founder_crop,
                               "einkorn wheat" = "wheat",
                               "emmer wheat" = "wheat",
                               .default = founder_crop)) %>% 
  count(century, founder_crop) %>% 
  # Refactor categories for plot
  mutate(founder_crop = fct_reorder(founder_crop, n, .fun = sum)) %>% 
  drop_na(founder_crop) %>% 
  # Plot
  ggplot(aes(century / 1000, n, fill = founder_crop)) +
  geom_area() +
  scale_x_reverse(breaks = scales::breaks_width(-1), limits = c(11.7, 6.5)) +
  khroma::scale_fill_muted() +
  labs(title = "Founder crops: occurrence & abundance by century",
       subtitle = "Cross-assemblage ubiquity",
       x = NULL, y = "n assemblages present", fill = NULL) +
  theme_minimal() ->
  p1

# By average proportion
flora_ts %>%
  # Aggregate wheat and drop non-founder crops
  mutate(founder_crop = recode(founder_crop,
                               "einkorn wheat" = "wheat",
                               "emmer wheat" = "wheat",
                               .default = founder_crop)) %>% 
  # Aggregate by founder crops
  group_by(century, site_name, phase_code, founder_crop) %>% 
  summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop") %>% 
  # Add number of assemblages per century
  group_by(century) %>% 
  mutate(n_assemb = length(unique(phase_code))) %>% 
  # Calculate average proportion
  group_by(century, founder_crop) %>%
  summarise(avg_prop = sum(prop) / first(n_assemb)) %>%
  # Refactor categories for plot
  mutate(
    founder_crop = fct_reorder(founder_crop, avg_prop, .fun = sum, .desc = FALSE),
    # founder_crop = fct_explicit_na(founder_crop, "Other (not founder crop)")
  ) %>% 
  drop_na(founder_crop) %>% 
  # Plot
  ggplot(aes(century / 1000, avg_prop, fill = founder_crop)) +
  geom_area() +
  scale_x_reverse(breaks = scales::breaks_width(-1), limits = c(11.7, 6.5)) +
  scale_y_continuous(limits = c(0, 0.5), breaks = scales::breaks_pretty(5),
                     labels = scales::percent) +
  khroma::scale_fill_muted() +
  labs(subtitle = "Relative abundance",
       x = "ka cal BP", y = "average proportion", fill = NULL) +
  theme_minimal() ->
  p2

p1 / p2

# ggsave(here("analysis/figures/ts-founder-crops.pdf"), width = 160, height = 160,
       # units = "mm")
```

### Plant categories

To move beyond the concept of "founder crops" vs. "wild plants", we classified each taxonomic record in our dataset on a number of other axes:

* Broad plant category, i.e. grasses, legumes, "wild plants", or fruits/nuts
* Its edibility
* For grasses and legumes, whether it is large/medium- or small-seeded

```{r category-summary, layout='l-body-outset'}
flora %>% 
  filter(period %in% neolithic) %>% 
  mutate(category = replace_na(category, "Unclassified")) %>% 
  group_by(site_name, phase_code, category) %>%
  summarise(
    n = sum(n, na.rm = TRUE),
    prop = sum(prop, na.rm = TRUE), 
    .groups = "drop"
  ) %>% 
  group_by(category) %>% 
  summarise(
    prop_avg = mean(prop),
    n_present = n(),
    n_gthalf = sum(prop > 0.5),
    n_gtqrtr = sum(prop > 0.25),
    pct_present = n_present / n_assemb_neolithic,
    pct_gthalf = n_gthalf / n_assemb_neolithic,
    pct_gtqrtr = n_gtqrtr / n_assemb_neolithic,
    .groups = "drop"
  ) %>% 
  arrange(desc(prop_avg)) %>% 
  gt(caption = "Abundance and ubiquity of broad plant categories across Neolithic assemblages.") %>% 
  cols_label(
    category = "Category",
    prop_avg = "Average proportion",
    n_present = "Present",
    n_gthalf = "More than ½",
    n_gtqrtr = "More than ¼"
  ) %>% 
  cols_merge_n_pct(n_present, pct_present) %>% 
  cols_merge_n_pct(n_gthalf, pct_gthalf) %>% 
  cols_merge_n_pct(n_gtqrtr, pct_gtqrtr) %>% 
  fmt_percent(starts_with("pct")) %>% 
  fmt_percent(prop_avg) %>% 
  cols_align("left", category)
```

```{r category-summary-byperiod, layout='l-body-outset'}
flora %>% 
  mutate(category = replace_na(category, "Unclassified")) %>% 
  group_by(period, site_name, phase_code, category) %>%
  summarise(
    n = sum(n, na.rm = TRUE),
    prop = sum(prop, na.rm = TRUE), 
    .groups = "drop"
  ) %>% 
  group_by(period) %>% 
  mutate(n_assemb = length(unique(phase_code))) %>% 
  group_by(period, category) %>% 
  summarise(
    prop_avg = mean(prop),
    n_present = n(),
    n_gthalf = sum(prop > 0.5),
    n_gtqrtr = sum(prop > 0.25),
    pct_present = n_present / first(n_assemb),
    pct_gthalf = n_gthalf / first(n_assemb),
    pct_gtqrtr = n_gtqrtr / first(n_assemb),
    .groups = "drop_last"
  ) %>% 
  arrange(desc(prop_avg), .by_group = TRUE) %>% 
  gt(caption = "Abundance and ubiquity of broad plant categories, by period.") %>% 
  cols_label(
    category = "Category",
    prop_avg = "Average proportion",
    n_present = "Present",
    n_gthalf = "More than ½",
    n_gtqrtr = "More than ¼"
  ) %>% 
  cols_merge_n_pct(n_present, pct_present) %>% 
  cols_merge_n_pct(n_gthalf, pct_gthalf) %>% 
  cols_merge_n_pct(n_gtqrtr, pct_gtqrtr) %>% 
  fmt_percent(starts_with("pct")) %>% 
  fmt_percent(prop_avg) %>% 
  cols_align("left", category)
```

Table \@ref(tab:category-summary) summarises the abundance of the broad plant categories across Neolithic assemblages, \@ref(tab:category-summary-byperiod) the same data broken down by period, and figure \@ref(fig:category-ts) how this changed through time.

```{r category-ts, fig.cap='Abundance of broad plant categories through time', layout='l-body-outset'}
flora_ts %>% 
  # Aggregate by category
  group_by(century, site_name, phase_code, category) %>% 
  summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop") %>% 
  # Add total number of assemblages per century
  group_by(century) %>% 
  mutate(n_assemb = length(unique(phase_code))) %>% 
  # Calculate average proportion
  group_by(century, category) %>%
  summarise(avg_prop = sum(prop) / first(n_assemb)) %>%
  # Refactor categories for plot
  mutate(
    category = fct_reorder(category, avg_prop, .fun = sum, .desc = FALSE),
    category = fct_explicit_na(category, "Unclassified")
  ) %>% 
  # Plot
  ggplot(aes(century / 1000, avg_prop, fill = category)) +
  geom_area() +
  scale_x_reverse(breaks = scales::breaks_width(-1), limits = c(11.7, 6.5)) +
  scale_y_continuous(breaks = scales::breaks_pretty(5), labels = scales::percent) +
  khroma::scale_fill_muted() +
  labs(x = "ka cal BP", y = "average proportion", fill = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

In the following sections, we will analyse trends within these categories in more detail.

#### Grasses

```{r common-grasses}
flora %>% 
  filter(category == "Grasses", period %in% neolithic) %>% 
  group_by(taxon) %>% 
  summarise(n_present = n()) %>% 
  arrange(desc(n_present)) %>% 
  slice(1:8) %>% 
  pull(taxon) ->
  top_grasses
```

The eight most ubiquitous grass taxonomic groups, measured by presence across Neolithic assemblages, are: `r paste(top_grasses, collapse = ", ")`.
Figure \@ref(fig:grasses-ts) shows how the abundance of these taxa changed through time.

```{r grasses-ts, fig.cap='Abundance of grass taxa through time', layout='l-body-outset'}
flora_ts %>% 
  # Include only top 8 grasses
  filter(category == "Grasses") %>% 
  mutate(taxon = if_else(taxon %in% top_grasses, taxon, NA_character_)) %>% 
  # Aggregate by taxon
  # group_by(century, site_name, phase_code, taxon) %>% 
  # summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop") %>% 
  # Add total number of assemblages per century
  group_by(century) %>% 
  mutate(n_assemb = length(unique(phase_code))) %>% 
  # Calculate average proportion per century
  group_by(century, taxon) %>%
  summarise(avg_prop = sum(prop) / first(n_assemb), .groups = "drop_last") %>%
  # Refactor categories for plot
  mutate(
    taxon = fct_reorder(taxon, avg_prop, .fun = sum, .desc = FALSE),
    taxon = fct_explicit_na(taxon, "Other")) %>% 
  # Plot
  ggplot(aes(century / 1000, avg_prop, fill = str_wrap(taxon, 60))) +
  geom_area() +
  scale_x_reverse(breaks = scales::breaks_width(-1), limits = c(11.7, 6.5)) +
  scale_y_continuous(breaks = scales::breaks_pretty(5), labels = scales::percent) +
  khroma::scale_fill_muted(guide = guide_legend(ncol = 2)) +
  labs(x = "ka cal BP", y = "average proportion", fill = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")
```
 
#### Pulses

```{r common-pulses}
flora %>% 
  filter(category == "Pulses", period %in% neolithic) %>% 
  group_by(taxon) %>% 
  summarise(n_present = n()) %>% 
  arrange(desc(n_present)) %>% 
  slice(1:8) %>% 
  pull(taxon) ->
  top_pulses
```

The eight most ubiquitous pulse taxonomic groups, measured by presence across Neolithic assemblages, are: `r paste(top_pulses, collapse = ", ")`.
Figure \@ref(fig:pulses-ts) shows how the abundance of these taxa changed through time.

```{r pulses-ts, fig.cap='Abundance of pulse taxa through time', layout='l-body-outset'}
flora_ts %>% 
  # Include only top 8 grasses
  filter(category == "Pulses") %>% 
  mutate(taxon = if_else(taxon %in% top_pulses, taxon, NA_character_)) %>% 
  # Aggregate by taxon
  # group_by(century, site_name, phase_code, taxon) %>% 
  # summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop") %>% 
  # Add total number of assemblages per century
  group_by(century) %>% 
  mutate(n_assemb = length(unique(phase_code))) %>% 
  # Calculate average proportion per century
  group_by(century, taxon) %>%
  summarise(avg_prop = sum(prop) / first(n_assemb), .groups = "drop_last") %>%
  # Refactor categories for plot
  mutate(
    taxon = fct_reorder(taxon, avg_prop, .fun = sum, .desc = FALSE),
    taxon = fct_explicit_na(taxon, "Other")) %>% 
  # Plot
  ggplot(aes(century / 1000, avg_prop, fill = str_wrap(taxon, 60))) +
  geom_area() +
  scale_x_reverse(breaks = scales::breaks_width(-1), limits = c(11.7, 6.5)) +
  scale_y_continuous(breaks = scales::breaks_pretty(5), labels = scales::percent) +
  khroma::scale_fill_muted(guide = guide_legend(ncol = 2)) +
  labs(x = "ka cal BP", y = "average proportion", fill = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

#### Wild plants

```{r common-wild-plants}
flora %>% 
  filter(category == "Wild plants", period %in% neolithic) %>% 
  group_by(taxon) %>% 
  summarise(n_present = n()) %>% 
  arrange(desc(n_present)) %>% 
  slice(1:8) %>% 
  pull(taxon) ->
  top_wild_plants
```

The eight most ubiquitous 'wild plant' taxonomic groups, measured by presence across Neolithic assemblages, are: `r paste(top_wild_plants, collapse = ", ")`.
Figure \@ref(fig:wild-plants-ts) shows how the abundance of these taxa changed through time.

```{r wild-plants-ts, fig.cap='Abundance of wild plant taxa through time', layout='l-body-outset'}
flora_ts %>% 
  # Include only top 8 grasses
  filter(category == "Wild plants") %>% 
  mutate(taxon = if_else(taxon %in% top_wild_plants, taxon, NA_character_)) %>% 
  # Aggregate by taxon
  # group_by(century, site_name, phase_code, taxon) %>% 
  # summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop") %>% 
  # Add total number of assemblages per century
  group_by(century) %>% 
  mutate(n_assemb = length(unique(phase_code))) %>% 
  # Calculate average proportion per century
  group_by(century, taxon) %>%
  summarise(avg_prop = sum(prop) / first(n_assemb), .groups = "drop_last") %>%
  # Refactor categories for plot
  mutate(
    taxon = fct_reorder(taxon, avg_prop, .fun = sum, .desc = FALSE),
    taxon = fct_explicit_na(taxon, "Other")) %>% 
  # Plot
  ggplot(aes(century / 1000, avg_prop, fill = str_wrap(taxon, 60))) +
  geom_area() +
  scale_x_reverse(breaks = scales::breaks_width(-1), limits = c(11.7, 6.5)) +
  scale_y_continuous(breaks = scales::breaks_pretty(5), labels = scales::percent) +
  khroma::scale_fill_muted(guide = guide_legend(ncol = 2)) +
  labs(x = "ka cal BP", y = "average proportion", fill = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

#### Fruits and nuts

```{r common-fruits-nuts}
flora %>% 
  filter(category == "Fruits/nuts", period %in% neolithic) %>% 
  group_by(taxon) %>% 
  summarise(n_present = n()) %>% 
  arrange(desc(n_present)) %>% 
  slice(1:8) %>% 
  pull(taxon) ->
  top_fruits_nuts
```

The eight most ubiquitous fruit/nut taxonomic groups, measured by presence across Neolithic assemblages, are: `r paste(top_fruits_nuts, collapse = ", ")`.
Figure \@ref(fig:fruits-nuts-ts) shows how the abundance of these taxa changed through time.

```{r fruits-nuts-ts, fig.cap='Abundance of fruit/nut taxa through time', layout='l-body-outset'}
flora_ts %>% 
  # Include only top 8 grasses
  filter(category == "Fruits/nuts") %>% 
  mutate(taxon = if_else(taxon %in% top_fruits_nuts, taxon, NA_character_)) %>% 
  # Aggregate by taxon
  # group_by(century, site_name, phase_code, taxon) %>% 
  # summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop") %>% 
  # Add total number of assemblages per century
  group_by(century) %>% 
  mutate(n_assemb = length(unique(phase_code))) %>% 
  # Calculate average proportion per century
  group_by(century, taxon) %>%
  summarise(avg_prop = sum(prop) / first(n_assemb), .groups = "drop_last") %>%
  # Refactor categories for plot
  mutate(
    taxon = fct_reorder(taxon, avg_prop, .fun = sum, .desc = FALSE),
    taxon = fct_explicit_na(taxon, "Other")) %>% 
  # Plot
  ggplot(aes(century / 1000, avg_prop, fill = str_wrap(taxon, 60))) +
  geom_area() +
  scale_x_reverse(breaks = scales::breaks_width(-1), limits = c(11.7, 6.5)) +
  scale_y_continuous(breaks = scales::breaks_pretty(5), labels = scales::percent) +
  khroma::scale_fill_muted(guide = guide_legend(ncol = 2)) +
  labs(x = "ka cal BP", y = "average proportion", fill = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")
```
