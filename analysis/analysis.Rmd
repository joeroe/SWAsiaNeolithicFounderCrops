---
title: '"Founder Crops" in the Neolithic of Southwest Asia – Data Analysis'
subtitle: "Data analysis"
author:
  - first_name: "Joe"
    last_name: "Roe"
    url: https://joeroe.io
    affiliation: Institute of Archaeological Sciences, University of Bern
    orcid_id: 0000-0002-1011-1244
  - first_name: "Amaia"
    last_name: "Arranz Otaegui"
    affiliation: Muséum National d'Histoire Naturelle, Paris
    orcid_id: 0000-0002-5091-6426
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 4
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE
)
```

```{r deps}
library("tidyverse")
library("SWAsiaNeolithicFounderCrops")
library("swapdata")
library("sf")
library("ggspatial")
library("here")
library("gt")
library("glue")
library("patchwork")
```

This research compendium accompanies the paper `...`.

## Methods & Materials

### Study region and period

```{r data-spatial, fig.cap='Study region and sites.'}
proj <- 22770
unproj <- 4326

sw_asia <- st_read(here("analysis/data/raw_data/regions/swasia.geojson"))

land <- st_read(here("analysis/data/raw_data/ne/ne_50m_land.shp"))
rivers <- st_read(here("analysis/data/raw_data/ne/ne_50m_rivers_lake_centerlines_scale_rank.shp"))
lakes <- st_read(here("analysis/data/raw_data/ne/ne_50m_lakes.shp"))
highland <- st_read(here("analysis/data/raw_data/srtm/srtm30_sw_asia_1000m.geojson"))
highland <- filter(highland, above_1000m == 1)

base_map <- ggplot() +
  shadow_spatial(st_bbox(sw_asia), fill = NA) +
  annotation_spatial(land, fill = "white") +
  annotation_spatial(highland, fill = "#f0f0f0", colour = NA) +
  annotation_spatial(rivers, colour = "#555555", size = 0.5) +
  annotation_spatial(lakes, fill = "lightblue") +
  coord_sf(expand = FALSE, crs = proj)

base_map
```

We aimed to collate archaeobotanical data from Southwest Asia (fig. \@ref(fig:region)) from the Neolithic period, c. 11,700 – 6500 BP.
To mitigate against an "edge effect", we also included samples in the source databases dated to the preceding Late Epipalaeolithic (c. 15,000–11,700 BP) and succeeding Chalcolithic (c. 6500–5000 BP).

```{r periods, fig.cap='Definition of cultural periods used in the analysis.'}
periods <- tribble(
  ~period,           ~agriculture,                    ~start_bp, ~end_bp,
  "Late Epipal.",    "Foraging",                      15000,     11700,
  "PPNA",            "Pre-domestication cultivation", 11700,     10700,
  "EPPNB",           "Domestication",                 10700,     10200,
  "MPPNB",           "Domestication",                 10200,     9500,
  "LPPNB",           "Agriculture",                   9500,      8500,
  "Late Neolithic",  "Agriculture",                   8500,      6500,
  "Chalcolithic",    "Agriculture",                   6500,      5000,
)

neolithic <- c("PPNA", "EPPNB", "MPPNB", "LPPNB", "Late Neolithic")

periods %>% 
  gt() %>% 
  cols_label(period = "Period", agriculture = "Agricultural stage",
             start_bp = "Start (cal BP)", end_bp = "End (cal BP")
```

### Archaeobotanical data

We collated data from three large-scale archaeobotanical databases: ORIGINS [@Wallace2018], and COMPAG [@Lucas2018; @Fuller2018], and ADEMNES [@Riehl2005].

Notes on collation:

* Standardised site names across databases
* Standardised taxa across databases and classified by ...
* When sites were in multiple databases, preferred records from the most detailed/recent one (i.e. ORIGINS > COMPAG > ADEMNES)
* Some sites in ADEMNES have an N/prop. of 0 for all taxa. I assumed this meant that they were present but that quantification data was not available.
* ORIGINS is recorded by sample; COMPAG and ADEMNES by phases. Aggregated ORIGINS by phase for comparability, and because individual samples are more likely to be 'noisy'
* Calculated phase-level proportions for COMPAG

We filtered this data to include only samples from our region (Southwest Asia) and period (11,700–6500 BP) of interest,
with a buffer of ±2,000 years to reduce "edge effects" in our time series analyses.

```{r data-flora}
start_bp <- first(periods$start_bp)
end_bp <- last(periods$end_bp)
flora <- collate_flora(
  origins_path = here("analysis/data/raw_data/origins/"),
  ademnes_path = here("analysis/data/raw_data/ademnes"),
  compag_path = here("analysis/data/raw_data/compag2018"),
  taxa_path = here("analysis/data/raw_data/founder_crops.tsv"),
  region = sw_asia,
  start_bp = start_bp,
  end_bp = end_bp
)

# Summary totals
flora %>% 
  distinct(site_name) %>% 
  nrow() ->
  n_site

flora %>% 
  distinct(site_name, phase_code) %>% 
  nrow() ->
  n_assemb
```

The resulting collated dataset (included as supplement?) includes archaeobotanical assemblages representing `r n_assemb` distinct phases from `r n_site` sites.

### Chronology

All three databases include rough calibrated date ranges for each sample, so we will use that for now.
We might look into using actual radiocarbon dates and incorporating the associated uncertainty into the analysis.

Using this data, each phase was classified into one of the cultural periods defined above using its mid-point date.

```{r sample-periods}
flora <- mutate(
  flora,
  age_mid = age_end + ((age_start - age_end) / 2),
  period = cut(-age_mid, 
               breaks = -c(periods$start_bp, 0), 
               labels = periods$period,
               ordered_result = TRUE)
)

flora %>% 
  distinct(period, site_name, phase) %>% 
  add_count(period, name ="n_phases") %>% 
  distinct(period, site_name, n_phases) %>% 
  add_count(period, name = "n_sites") %>% 
  distinct(period, n_phases, n_sites) %>% 
  select(period, n_sites, n_phases) %>% 
  arrange(period) %>%
  gt() %>% 
  cols_label(period = "Period", n_sites = "Sites", n_phases = "Assemblages") 

flora %>% 
  distinct(site_name, phase_code, period) %>% 
  filter(period %in% neolithic) %>% 
  nrow() ->
  n_assemb_neolithic

flora %>% 
  filter(period %in% neolithic) %>% 
  distinct(site_name) %>% 
  nrow() ->
  n_site_neolithic
```

For a finer-grained chronology, we also sliced the assemblages into century bins.

```{r sample-centuries}
centuries <- seq(from = first(periods$start_bp),
                 to = last(periods$end_bp),
                 by = -100)
names(centuries) <- centuries

flora %>% 
  mutate(century = map_dfc(centuries, ~. < age_start & . > age_end)) %>% 
  unpack(century) %>% 
  pivot_longer((ncol(flora)+1):ncol(.), names_to = "century",
               names_transform = list(century = as.integer)) %>% 
  filter(value) %>% 
  select(-value) %>% 
  mutate(period = cut(-century, 
               breaks = -c(periods$start_bp, last(periods$end_bp)), 
               labels = periods$period,
               ordered_result = TRUE)) ->
  flora_ts
```

### Sample coverage

```{r sample-summary}
flora %>% 
  group_by(site_name, phase_code) %>% 
  summarise(across(c(source, latitude, longitude, phase, age_start, age_end,
                     period), first),
            .groups = "drop") ->
  flora_phases
```


```{r sample-map, fig.cap='Geographical distribution of sampled archaeobotanical assemblages'}
p1 <- base_map + 
  geom_spatial_point(data = flora_phases, 
                     mapping = aes(longitude, latitude),
                     size = 0.5) +
  labs(x = NULL, y = NULL)
  
p1_left <- p1 + facet_wrap(vars("All sites"))
p1_right <- p1 + 
  facet_wrap(vars(period)) + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

p1_left + p1_right

# ggsave(here("analysis/figures/sample-map.pdf"), width = 235, height = 160, 
#        units = "mm")
# ggsave(here("analysis/figures/sample-map.png"), width = 160, height = 80,
#        units = "mm", dpi = 300)
```


```{r sample-chronology, fig.cap='Chronological distribution of sampled archaeobotanical assemblages'}
p2_top <- flora_phases %>% 
  count(period) %>% 
  left_join(periods) %>% 
  mutate(period = ordered(period, levels = periods$period)) %>% 
  ggplot(aes(xmin = start_bp, xmax = end_bp, ymin = 0, ymax = n,
             fill = period)) +
  geom_rect() +
  scale_x_reverse(limits = c(15000, 5000),
                  breaks = seq(15000, 5000, -1000)) +
  scale_y_continuous(limits = c(0, 150)) +
  khroma::scale_fill_discreterainbow() +
  labs(x = NULL, y = "Samples by period", fill = "Period") +
  theme(legend.position = "top", 
        axis.text.x = element_blank(), axis.ticks.x = element_blank())

p2_bottom <- flora_ts %>% 
  group_by(site_name, phase_code, century) %>% 
  summarise(period = first(period), .groups = "drop") %>% 
  ggplot(aes(century, fill = period)) +
  geom_bar(width = 100) +
  scale_x_reverse(limits = c(15000, 5000), 
                  breaks = seq(15000, 5000, -1000)) +
  scale_y_reverse(limits = c(150, 0)) +
  khroma::scale_fill_discreterainbow(guide = guide_none()) +
  labs(x = "cal BP", y = "Samples by century") +
  theme(legend.position = "bottom")

p2_top / p2_bottom

# ggsave(here("analysis/figures/sample-chronology.pdf"), width = 160, height = 100, 
#        units = "mm")
```

## Results – Question 1

Were the founder crops the *most important* plants?

### Table of occurrences

For each plant category (grass, legume, etc.), take the top X controlled taxa, and calculate:

* n and proportion of site-phases where it is present
* n and proportion of site-phases where it is >50%
* n and proportion of site-phases where it is >25%
* earliest recorded presence
* earliest recorded presence outside of SWA??

Including only *Neolithic* site-phases.

```{r occ-all}
flora %>% 
  drop_na(category, taxon) %>% 
  filter(period %in% neolithic) %>% 
  group_by(category, taxon, phase_code) %>% 
  summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop_last") %>% 
  summarise(
    n_present = sum(prop > 0),
    n_gthalf = sum(prop > 0.5),
    n_gtqrtr = sum(prop > 0.25),
    .groups = "drop_last"
  ) %>% 
  mutate(
    pct_present = n_present / n_assemb_neolithic,
    pct_gthalf = n_gthalf / n_assemb_neolithic,
    pct_gtqrtr = n_gtqrtr / n_assemb_neolithic
  ) %>% 
  arrange(-n_present, .by_group = TRUE) %>% 
  slice_max(n_present, n = 10, with_ties = FALSE) %>%
  gt() %>% 
  fmt_percent(c(pct_present, pct_gthalf, pct_gtqrtr)) %>% 
  cols_merge_n_pct(n_present, pct_present) %>% 
  cols_merge_n_pct(n_gthalf, pct_gthalf) %>% 
  cols_merge_n_pct(n_gtqrtr, pct_gtqrtr) %>% 
  cols_label(taxon = "Taxon",
             n_present = "N (%) recorded present",
             n_gthalf = "N (%) making up more than half of assemblage",
             n_gtqrtr = "N (%) making up more than a quarter of assemblage") %>% 
  tab_style(cell_text(style = "italic"), cells_body(taxon)) ->
  occ_all

# gtsave(occ_all, "figures/occ_all.html")
```

### Founder crops

Number & percentage of assemblages with *all* the founder crops reported, by period:

```{r occ-founder}
flora %>% 
  mutate(founder_crop = recode(founder_crop,
                               "emmer wheat" = "wheat",
                               "einkorn wheat" = "wheat",
                               .default = founder_crop)) %>% 
  group_by(period, site_name, phase_code) %>% 
  summarise(n_founder_crop = n_distinct(founder_crop, na.rm = TRUE),
            .groups = "drop") %>% 
  group_by(period) %>% 
  summarise(
    n_assemb = n(),
    n_atleast7 = sum(n_founder_crop >= 7),
    p_atleast7 = n_atleast7 / n_assemb,
    n_atleast6 = sum(n_founder_crop >= 6),
    p_atleast6 = n_atleast6 / n_assemb,
    n_atleast5 = sum(n_founder_crop >= 5),
    p_atleast5 = n_atleast5 / n_assemb,
    n_atleast4 = sum(n_founder_crop >= 4),
    p_atleast4 = n_atleast4 / n_assemb,
    n_atleast3 = sum(n_founder_crop >= 3),
    p_atleast3 = n_atleast3 / n_assemb,
    n_atleast2 = sum(n_founder_crop >= 2),
    p_atleast2 = n_atleast2 / n_assemb,
    n_atleast1 = sum(n_founder_crop >= 1),
    p_atleast1 = n_atleast1 / n_assemb
  ) %>% 
  gt() %>% 
  fmt_percent(starts_with("p_")) %>% 
  cols_merge_n_pct(n_atleast7, p_atleast7) %>% 
  cols_merge_n_pct(n_atleast6, p_atleast6) %>% 
  cols_merge_n_pct(n_atleast5, p_atleast5) %>% 
  cols_merge_n_pct(n_atleast4, p_atleast4) %>% 
  cols_merge_n_pct(n_atleast3, p_atleast3) %>% 
  cols_merge_n_pct(n_atleast2, p_atleast2) %>% 
  cols_merge_n_pct(n_atleast1, p_atleast1) %>% 
  tab_spanner("Number of assemblages with N founder crops present:",
              columns = starts_with("n_atleast"), id = "n_atleast") %>% 
  cols_label(
    period = "Period",
    n_assemb = "Total assemblages",
    n_atleast7 = "All",
    n_atleast6 = ">= 6",
    n_atleast5 = ">= 5",
    n_atleast4 = ">= 4",
    n_atleast3 = ">= 3",
    n_atleast2 = ">= 2",
    n_atleast1 = ">= 1"
  ) %>% 
  tab_footnote("Emmer wheat and einkorn wheat are counted as one crop.",
               locations = cells_column_spanners())
```

Number & percentage of assemblages with founder crops making up `P`% of the assemblage, by period:

TODO

absolute counts (separating PPNA, PPNB-PPNC and PN), similar to the diagram in Quaternary Science Reviews but including the Pottery Neolithic. 
It would also be cool to do it by species, to see how the exploitation for each of the taxa increase/decreases over time.
I.e. vertical axis (absolute counts), horizontal axis (time), species represented by different colors?

```{r ts-founder-crops}
# TODO: Decide on quantification strategy!
# TODO: Deal with ADEMNES sites with sum(prop) = 0 better
# TODO: Why are some sum(prop) over 1?

# Strategy A: presence/absence
flora_ts %>% 
  group_by(century, site_name, phase_code) %>% 
  summarise(founder_crop = any(!is.na(founder_crop)), .groups = "drop") %>% 
  group_by(century) %>% 
  summarise(prop = sum(founder_crop) / n()) %>% 
  ggplot(aes(century, prop)) +
  geom_area() +
  scale_x_reverse() +
  labs(x = "cal BP", y = "Proportion of assemblages with any founder crops") +
  theme(legend.position = "bottom")

# ggsave(here("analysis/figures/fig2a.pdf"), width = 160, height = 100, 
#        units = "mm")

# Strategy B: ubiquity cutoff
flora_ts %>%
  mutate(founder_crop = replace_na(founder_crop, FALSE),
         prop = replace_na(prop, 0)) %>% 
  group_by(century, site_name, phase_code) %>% 
  summarise(founder_crop = sum(founder_crop * prop), .groups = "drop") %>% 
  mutate(
    above_5 = founder_crop > 0.05,
    above_10 = founder_crop > 0.10,
    above_25 = founder_crop > 0.25,
    above_50 = founder_crop > 0.50
  ) %>% 
  pivot_longer(above_5:above_50, names_to = "cutoff", values_to = "above") %>% 
  mutate(cutoff = ordered(paste0(cutoff, "%"),
                          levels = c("above_5%", "above_10%", "above_25%", "above_50%"))) %>% 
  group_by(century, cutoff) %>% 
  summarise(prop = sum(above) / n()) %>% 
  ggplot(aes(century, prop)) +
  facet_wrap(vars(cutoff), ncol = 1) +
  geom_area() +
  scale_x_reverse() +
  labs(x = "cal BP", y = "Proportion of assemblages with >X% founder crops") +
  theme(legend.position = "bottom")

# ggsave(here("analysis/figures/fig2b.pdf"), width = 160, height = 200, 
#        units = "mm")

# Strategy C: average proportion
flora_ts %>%
  group_by(century, site_name, phase_code) %>% 
  mutate(sumprop = sum(prop, na.rm = TRUE)) %>% 
  filter(sumprop != 0) %>% 
  group_by(century, site_name, phase_code, founder_crop) %>% 
  summarise(prop = sum(prop, na.rm = TRUE), .groups = "drop") %>% 
  group_by(century, founder_crop) %>% 
  summarise(prop = sum(prop) / n(), .groups = "drop") %>% 
  mutate(
    founder_crop = factor(paste(founder_crop),
                          c("NA", "FALSE", "TRUE"),
                          c("Indeterminate", "Not founder crop", "Founder crop"),
                          ordered = TRUE)
  ) %>% 
  ggplot(aes(century, prop, fill = founder_crop)) +
  geom_area() +
  scale_x_reverse() +
  scale_fill_contrast(guide = guide_legend(reverse = TRUE)) +
  labs(x = "cal BP", y = "Average proportion of samples", fill = NULL) +
  theme(legend.position = "bottom")

# ggsave(here("analysis/figures/fig2c.pdf"), width = 160, height = 100, 
#        units = "mm")
```

### Grasses
 
### Legumes

### Wild plants

### Fruits and nuts

## Results – Question 2

Were the founder crops the *earliest* plants?

### *T. aestivum/durum.*

Earliest reported occurrences:

```{r occ-t-aestivum-durum, layout='l-body-outset'}
flora %>% 
  filter(taxon %in% c("Triticum aestivum", "Triticum durum") | 
           taxon_source %in% c("Triticum aestivum/durum",
                               "Triticum dicoccum/aestivum",
                               "Triticum dicoccum/durum")) %>% 
  arrange(-age_start) %>% 
  group_by(source, site_name, taxon_source) %>% 
  summarise(phase_code = first(phase_code), earliest_age = first(age_start),
            n = sum(n), reference = first(reference),
            .groups = "drop") %>% 
  mutate(reference = str_remove(reference, ";.*")) %>% 
  arrange(-earliest_age) %>% 
  slice(1:10) %>% 
  gt() %>% 
  cols_label(source = "Database", site_name = "Site", phase_code = "Phase",
             taxon_source = "Reported taxon", 
             earliest_age = "Reported age (earliest)", n = "N",
             reference = "Reference")
```

### *T. spelta*

Rarely reported, so all sites it occurs at, ordered by age:

```{r occ-t-spelta, layout='l-body-outset'}
flora %>% 
  filter(taxon == "Triticum spelta" | 
           taxon_source %in% c("Triticum dicoccum/spelta",
                               "Triticum dicoccum/spelta grains")) %>% 
  arrange(-age_start) %>% 
  group_by(source, site_name, taxon_source) %>% 
  summarise(phase_code = first(phase_code), earliest_age = first(age_start),
            n = sum(n), reference = first(reference),
            .groups = "drop") %>% 
  mutate(reference = str_remove(reference, ";.*")) %>% 
  arrange(-earliest_age) %>% 
  slice(1:10) %>% 
  gt() %>% 
  cols_label(source = "Database", site_name = "Site", phase_code = "Phase",
             taxon_source = "Reported taxon", 
             earliest_age = "Reported age (earliest)", n = "N",
             reference = "Reference")
```

### *T. monococcum*

Earliest reported assemblages with >5%, from the LPPNB or later.
**AMAIA:** Arbitrarily chosen cutoff, let me know if you want me to adjust.

```{r occ-monococcum, layout='l-body-outset'}
flora %>% 
  filter(taxon == "Triticum monococcum") %>% 
  filter(prop > 0.05) %>% 
  filter(age_start < periods$start_bp[periods$period == "LPPNB"]) %>% 
  arrange(-age_start) %>% 
  group_by(source, site_name, taxon_source) %>% 
  summarise(phase_code = first(phase_code), earliest_age = first(age_start),
            prop = max(prop), reference = first(reference),
            .groups = "drop") %>% 
  mutate(reference = str_remove(reference, ";.*")) %>% 
  arrange(-earliest_age) %>% 
  slice(1:10) %>% 
  gt() %>% 
  cols_label(source = "Database", site_name = "Site", phase_code = "Phase",
             taxon_source = "Reported taxon", 
             earliest_age = "Reported age (earliest)", prop = "Highest %",
             reference = "Reference") %>% 
  fmt_percent(vars(prop))
```

Reference to 2-3 sites contemporary to Çatal Höyuk or later, specially Pottery Neolithic, where one-grained einkorn is found at a significant amount.

### *H. spontaneum/vulgare*

Earliest reported assemblages with >5%.
**AMAIA:** Arbitrarily chosen cutoff, let me know if you want me to adjust.

```{r occ-hordeum, layout='l-body-outset'}
flora %>% 
  filter(taxon %in% c("Hordeum spontaneum", "Hordeum vulgare")) %>% 
  filter(prop > 0.05) %>% 
  arrange(-age_start) %>% 
  group_by(source, site_name, taxon_source) %>% 
  summarise(phase_code = first(phase_code), earliest_age = first(age_start),
            prop = max(prop), reference = first(reference),
            .groups = "drop") %>% 
  mutate(reference = str_remove(reference, ";.*")) %>% 
  arrange(-earliest_age) %>% 
  slice(1:10) %>% 
  gt() %>% 
  cols_label(source = "Database", site_name = "Site", phase_code = "Phase",
             taxon_source = "Reported taxon", 
             earliest_age = "Reported age (earliest)", prop = "Highest %",
             reference = "Reference") %>% 
  fmt_percent(vars(prop))
```

### *Avena*

Earliest reported assemblages with >2% (there aren't many).
**AMAIA:** Arbitrarily chosen cutoff, let me know if you want me to adjust.

```{r occ-avena, layout='l-body-outset'}
flora %>% 
  filter(genus == "Avena") %>% 
  filter(prop > 0.02) %>% 
  arrange(-age_start) %>% 
  group_by(source, site_name, taxon_source) %>% 
  summarise(phase_code = first(phase_code), earliest_age = first(age_start),
            prop = max(prop), reference = first(reference),
            .groups = "drop") %>% 
  mutate(reference = str_remove(reference, ";.*")) %>% 
  arrange(-earliest_age) %>% 
  slice(1:10) %>% 
  gt() %>% 
  cols_label(source = "Database", site_name = "Site", phase_code = "Phase",
             taxon_source = "Reported taxon", 
             earliest_age = "Reported age (earliest)", prop = "Highest %",
             reference = "Reference") %>% 
  fmt_percent(vars(prop))
```

### *Linum usitatissimum*

Earliest reported occurrences of *Linum usitatissimum* (flax) specifically:

```{r occ-flax, layout='l-body-outset'}
flora %>% 
  filter(taxon == "Linum usitatissimum" | 
           taxon_source == "Linum bienne/usitatissimum") %>% 
  arrange(-age_start) %>% 
  group_by(source, site_name, taxon_source) %>% 
  summarise(phase_code = first(phase_code), earliest_age = first(age_start),
            n = sum(n), reference = first(reference),
            .groups = "drop") %>% 
  mutate(reference = str_remove(reference, ";.*")) %>% 
  arrange(-earliest_age) %>% 
  slice(1:10) %>% 
  gt() %>% 
  cols_label(source = "Database", site_name = "Site", phase_code = "Phase",
             taxon_source = "Reported taxon", 
             earliest_age = "Reported age (earliest)", n = "N",
             reference = "Reference")
```

